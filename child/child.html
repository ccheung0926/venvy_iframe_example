<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Child</title>
</head>
<body>

  <h3>child.html</h3>

  <button id="try_again">Try again</button>

  <script>
    var get_user = function () {
      return new Promise(function (resolve, reject) {
        setTimeout(function () {
          resolve({
            name: "Ryan Dahl",
            fame: "NodeJS"
          });
        }, 500);
      });
    }

    var get_current_port = function () {
      return new Promise(function (resolve, reject) {
        resolve(window.location.port);
      })
    }

    function try_again(e) {
      /*
      Mimicing a database query for a user and sending the result of that request to the parent page.
      */
      get_user().then(function (user) {
        parent.postMessage({
          msg: "user_from_child",
          user: user
        }, "*");
      });
    }

    function child_msg_listener(e) {
      if (e.data.msg === "user_from_parent") {
        if (e.data.user) {
          console.log("found Ryan Dahl on parent page");
        } else {
          console.log("did not find Ryan Dahl on parent page");
        }
      }
    }

    document.getElementById("try_again").addEventListener("click", try_again)
    window.addEventListener("message", child_msg_listener)
  </script>
</body>
</html>
